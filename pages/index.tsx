import type { NextPage, GetServerSideProps } from 'next';
import Head from 'next/head';
import { Theme } from 'contexts/theme/theme-context';
import axios from 'axios';
import { CountriesContextProvider } from 'contexts/countries/countries';
import { Country } from 'contexts/countries/countries';
import { HeaderSection } from 'components/sections/header/header';
import { SearchAndFilterSection } from 'components/sections/search-and-filter/search-section';
import { CountriesListSection } from 'components/sections/countries-list/countries-list-section';


export const getServerSideProps: GetServerSideProps = async (context) => {

  const theme = (context.req.cookies?.theme ?? 'light') as Theme;
  const response: any = await axios.get('https://restcountries.com/v3.1/all');

  const countries: Country[] = response.data.map( (country: any) => {
    return {
      name: country.name.common,
      flag: country?.flags?.png || country?.flags?.svg || '',
      population: country.population ?? 0,
      region: country.region ?? null,
      capital: country.capital ?? ''
    }
  })

  return {
    props: { theme, countries },
  }
}


const Home: NextPage<{ theme: Theme, countries: Country[] }> = ({ countries }) => {
  
  return (
      <>
      <Head>
        <title>Create Next App</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>     
      <CountriesContextProvider countries={countries}>
        <main>
          <HeaderSection />
          <SearchAndFilterSection />
          <CountriesListSection/>
        </main>      
      </CountriesContextProvider>
    </>
  )
}

export default Home
